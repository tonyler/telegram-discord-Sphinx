<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sphinx Accounts Verification</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16.png">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <main>
            <div class="message success" id="successMessage" style="display: none;"></div>
            <div class="message error" id="errorMessage" style="display: none;"></div>

            <p class="description">Bind your accounts to earn XP in Sphinx Protocol's <span class="no-break">pre-testnet</span> campaign across all platforms.</p>

            <div class="platforms-grid">
                <div class="platform-button" id="discordBtn" style="cursor: pointer;">
                    <svg class="icon discord-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
                    </svg>
                    <div class="platform-button-content">
                        <span class="platform-button-name">Discord</span>
                        <span class="platform-button-status" id="discordStatus">Loading...</span>
                    </div>
                </div>

                <!-- Telegram -->
                <div class="platform-button" id="telegramBtn" style="cursor: pointer;">
                    <svg class="icon telegram-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19c-.14.75-.42 1-.68 1.03c-.58.05-1.02-.38-1.58-.75c-.88-.58-1.38-.94-2.23-1.5c-.99-.65-.35-1.01.22-1.59c.15-.15 2.71-2.48 2.76-2.69a.2.2 0 0 0-.05-.18c-.06-.05-.14-.03-.21-.02c-.09.02-1.49.95-4.22 2.79c-.4.27-.76.41-1.08.4c-.36-.01-1.04-.2-1.55-.37c-.63-.2-1.12-.31-1.08-.66c.02-.18.27-.36.74-.55c2.92-1.27 4.86-2.11 5.83-2.51c2.78-1.16 3.35-1.36 3.73-1.36c.08 0 .27.02.39.12c.1.08.13.19.14.27c-.01.06.01.24 0 .38z"/>
                    </svg>
                    <div class="platform-button-content">
                        <span class="platform-button-name">Telegram</span>
                        <span class="platform-button-status" id="telegramStatus">Not connected</span>
                    </div>
                </div>

            </div>

            <div class="social-links">
                <a href="https://discord.gg/sphinxprotocol" target="_blank" rel="noopener noreferrer" class="social-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
                    </svg>
                </a>
                <a href="https://x.com/SphinxProtocol" target="_blank" rel="noopener noreferrer" class="social-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                    </svg>
                </a>
                <a href="https://t.me/SphinxCryptChat" target="_blank" rel="noopener noreferrer" class="social-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19c-.14.75-.42 1-.68 1.03c-.58.05-1.02-.38-1.58-.75c-.88-.58-1.38-.94-2.23-1.5c-.99-.65-.35-1.01.22-1.59c.15-.15 2.71-2.48 2.76-2.69a.2.2 0 0 0-.05-.18c-.06-.05-.14-.03-.21-.02c-.09.02-1.49.95-4.22 2.79c-.4.27-.76.41-1.08.4c-.36-.01-1.04-.2-1.55-.37c-.63-.2-1.12-.31-1.08-.66c.02-.18.27-.36.74-.55c2.92-1.27 4.86-2.11 5.83-2.51c2.78-1.16 3.35-1.36 3.73-1.36c.08 0 .27.02.39.12c.1.08.13.19.14.27c-.01.06.01.24 0 .38z"/>
                    </svg>
                </a>
            </div>
        </main>
    </div>

    <script>
        let telegramPollInterval = null;

        async function loadUserData() {
            try {
                const response = await fetch('/auth/me');
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/';
                        return;
                    }
                    throw new Error('Failed to load user data');
                }

                const data = await response.json();
                displayUserData(data);
            } catch (error) {
                console.error('Error loading user data:', error);
                showError('Failed to load account information');
                document.getElementById('discordStatus').textContent = 'Error loading status';
                document.getElementById('telegramStatus').textContent = 'Error loading status';
            }
        }

        function displayUserData(data) {
            const discordBinding = data.bindings.discord;
            const telegramBinding = data.bindings.telegram;

            const discordBtn = document.getElementById('discordBtn');
            if (discordBinding) {
                document.getElementById('discordStatus').textContent = `✓ Connected as ${discordBinding.username}`;
                discordBtn.style.cursor = 'pointer';
                discordBtn.classList.add('connected');
            } else {
                document.getElementById('discordStatus').textContent = 'Not connected';
                discordBtn.style.cursor = 'pointer';
                discordBtn.classList.remove('connected');
            }

            const telegramBtn = document.getElementById('telegramBtn');
            if (telegramBinding) {
                document.getElementById('telegramStatus').textContent = `✓ Connected${telegramBinding.username ? ' as @' + telegramBinding.username : ''}`;
                telegramBtn.style.cursor = 'pointer';
                telegramBtn.classList.add('connected');
                stopTelegramPolling();
            } else {
                document.getElementById('telegramStatus').textContent = 'Not connected';
                telegramBtn.style.cursor = 'pointer';
                telegramBtn.classList.remove('connected');
            }
        }

        function stopTelegramPolling() {
            if (telegramPollInterval) {
                clearInterval(telegramPollInterval);
                telegramPollInterval = null;
            }
        }

        async function logout() {
            try {
                await fetch('/auth/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/';
            }
        }

        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        async function connectTelegram() {
            try {
                // Open popup IMMEDIATELY to avoid iOS blocking (must be synchronous with user click)
                const popup = window.open('about:blank', '_blank');

                if (!popup) {
                    showError('Popup blocked! Please allow popups for this site and try again.');
                    return;
                }

                // Add a loading message to the popup to improve UX
                try {
                    popup.document.write('<html><body style="margin:0;padding:40px;font-family:system-ui;text-align:center;background:#f5f5f5;"><h2>Loading Telegram...</h2><p>Please wait while we connect you to Telegram.</p></body></html>');
                } catch (e) {
                    // Ignore if we can't write to popup (cross-origin restrictions)
                }

                // Now fetch the auth URL (popup is already open, so iOS won't block)
                const response = await fetch('/auth/telegram');
                if (!response.ok) {
                    popup.close();
                    throw new Error('Failed to get Telegram auth URL');
                }

                const data = await response.json();

                // Check if popup is still open before redirecting
                if (popup.closed) {
                    showError('Popup was closed. Please try again.');
                    return;
                }

                // Redirect the already-open popup to the Telegram auth URL
                popup.location.href = data.auth_url;

                showSuccess('Opening Telegram... Follow the instructions in the bot chat.');

                stopTelegramPolling();

                let attempts = 0;
                const maxAttempts = 100;
                telegramPollInterval = setInterval(async () => {
                    attempts++;
                    try {
                        const response = await fetch('/auth/me');
                        if (response.ok) {
                            const data = await response.json();
                            if (data.bindings.telegram) {
                                stopTelegramPolling();
                                showSuccess('Telegram connected successfully!');
                                loadUserData();
                            }
                        }
                    } catch (error) {
                        console.error('Poll error:', error);
                    }

                    if (attempts >= maxAttempts) {
                        stopTelegramPolling();
                        showError('Connection timeout. Please refresh and try again.');
                    }
                }, 3000);

            } catch (error) {
                console.error('Error connecting Telegram:', error);
                showError('Failed to connect Telegram. Please try again.');
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const success = params.get('success');
            const error = params.get('error');

            if (success) {
                showSuccess(`${success.charAt(0).toUpperCase() + success.slice(1)} connected successfully!`);
                window.history.replaceState({}, document.title, '/dashboard');
            }

            if (error) {
                showError(error);
                window.history.replaceState({}, document.title, '/dashboard');
            }

            loadUserData();

            document.getElementById('discordBtn').addEventListener('click', function() {
                const isConnected = this.classList.contains('connected');
                document.getElementById('discordStatus').textContent = isConnected ? 'Reconnecting...' : 'Connecting...';
                window.location.href = '/auth/discord';
            });

            document.getElementById('telegramBtn').addEventListener('click', function() {
                const isConnected = this.classList.contains('connected');
                if (isConnected) {
                    document.getElementById('telegramStatus').textContent = 'Reconnecting...';
                }
                connectTelegram();
            });
        });

        window.addEventListener('beforeunload', () => {
            stopTelegramPolling();
        });

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopTelegramPolling();
            }
        });
    </script>
</body>
</html>
